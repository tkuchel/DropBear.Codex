@inject IPageAlertService PageAlertService
@inject IAsyncSubscriber<string, Notification> NotificationSubscriber
@using DropBear.Codex.Blazor.Enums
@using DropBear.Codex.Blazor.Interfaces
@using DropBear.Codex.Notifications.Models
@using MessagePipe
@inherits DropBear.Codex.Blazor.Components.Bases.DropBearComponentBase

<div id="page-alert-container" class="page-alert-container @(_activeAlerts.Any() ? "has-alerts" : "")">
    <CascadingValue Value="this" IsFixed="true">
        <ErrorBoundary @ref="_errorBoundary" Context="error">
            <ChildContent>
                @if (_activeAlerts.Any())
                {
                    @foreach (var alert in _activeAlerts.Values
                                      .OrderByDescending(a => a.IsPermanent)
                                      .ThenByDescending(a => GetAlertPriority(a.Type)))
                    {
                        <DropBearPageAlert @key="alert.Id"
                                           AlertId="@alert.Id"
                                           Title="@alert.Title"
                                           Message="@alert.Message"
                                           Type="@alert.Type"
                                           IsPermanent="@alert.IsPermanent"
                                           Duration="@alert.Duration"
                                           OnClose="@(() => RemoveAlertAsync(alert.Id))"/>
                    }
                }
            </ChildContent>
            <ErrorContent>
                @{
                    Logger.Error(error, "Error in alert container");
                }
                <div class="alert alert-danger" role="alert">
                    An error occurred displaying alerts. Please try refreshing the page.
                </div>
            </ErrorContent>
        </ErrorBoundary>
    </CascadingValue>
</div>

@code {
    private ErrorBoundary? _errorBoundary;

    protected override void OnParametersSet()
    {
        _errorBoundary?.Recover();
    }

    private async Task RemoveAlertAsync(string alertId)
    {
        if (_activeAlerts.TryRemove(alertId, out _))
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private static int GetAlertPriority(PageAlertType type)
    {
        return type switch
        {
            PageAlertType.Error => 4,
            PageAlertType.Warning => 3,
            PageAlertType.Success => 2,
            PageAlertType.Info => 1,
            _ => 0
        };
    }

}
